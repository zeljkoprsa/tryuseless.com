{"version":3,"sources":["../../../src/server/lib/prefetch-cache-scopes.ts"],"sourcesContent":["import type { CacheScopeStore } from '../async-storage/cache-scope.external'\n\nexport class PrefetchCacheScopes {\n  private cacheScopes = new Map<\n    string,\n    {\n      cache: CacheScopeStore['cache']\n      // we track timestamp as we evict after 30s\n      // if a prefetch cache scope isn't used by then\n      timestamp: number\n    }\n  >()\n\n  private evict() {\n    for (const [key, value] of this.cacheScopes) {\n      if (value.timestamp < Date.now() - 5_000) {\n        this.cacheScopes.delete(key)\n      }\n    }\n  }\n\n  // TODO: should this key include query params if so we need to\n  // filter _rsc query\n  get(url: string) {\n    setImmediate(() => this.evict())\n    const currentScope = this.cacheScopes.get(url)\n    if (currentScope) {\n      if (currentScope.timestamp < Date.now() - 5_000) {\n        return undefined\n      }\n      return currentScope.cache\n    }\n    return undefined\n  }\n\n  set(url: string, cache: CacheScopeStore['cache']) {\n    setImmediate(() => this.evict())\n    return this.cacheScopes.set(url, {\n      cache,\n      timestamp: Date.now(),\n    })\n  }\n\n  del(url: string) {\n    this.cacheScopes.delete(url)\n  }\n}\n"],"names":["PrefetchCacheScopes","evict","key","value","cacheScopes","timestamp","Date","now","delete","get","url","setImmediate","currentScope","undefined","cache","set","del","Map"],"mappings":";;;;+BAEaA;;;eAAAA;;;AAAN,MAAMA;IAWHC,QAAQ;QACd,KAAK,MAAM,CAACC,KAAKC,MAAM,IAAI,IAAI,CAACC,WAAW,CAAE;YAC3C,IAAID,MAAME,SAAS,GAAGC,KAAKC,GAAG,KAAK,MAAO;gBACxC,IAAI,CAACH,WAAW,CAACI,MAAM,CAACN;YAC1B;QACF;IACF;IAEA,8DAA8D;IAC9D,oBAAoB;IACpBO,IAAIC,GAAW,EAAE;QACfC,aAAa,IAAM,IAAI,CAACV,KAAK;QAC7B,MAAMW,eAAe,IAAI,CAACR,WAAW,CAACK,GAAG,CAACC;QAC1C,IAAIE,cAAc;YAChB,IAAIA,aAAaP,SAAS,GAAGC,KAAKC,GAAG,KAAK,MAAO;gBAC/C,OAAOM;YACT;YACA,OAAOD,aAAaE,KAAK;QAC3B;QACA,OAAOD;IACT;IAEAE,IAAIL,GAAW,EAAEI,KAA+B,EAAE;QAChDH,aAAa,IAAM,IAAI,CAACV,KAAK;QAC7B,OAAO,IAAI,CAACG,WAAW,CAACW,GAAG,CAACL,KAAK;YAC/BI;YACAT,WAAWC,KAAKC,GAAG;QACrB;IACF;IAEAS,IAAIN,GAAW,EAAE;QACf,IAAI,CAACN,WAAW,CAACI,MAAM,CAACE;IAC1B;;aA1CQN,cAAc,IAAIa;;AA2C5B"}